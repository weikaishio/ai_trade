# 主线题材检测 - 快速参考

## 🎯 功能说明

自动识别市场主线题材，帮助捕捉超短线交易机会。

**检测逻辑**:
1. 获取涨停股票和强势股票（涨幅≥5%）
2. 基于股票名称关键词聚类
3. 筛选有效题材（股票数≥2，平均涨幅≥2.5%）
4. 识别龙头股，计算题材强度评分

---

## 📊 支持的题材类别（19个）

| 题材类别 | 关键词示例 | 备注 |
|---------|----------|------|
| 芯片 | 芯片、半导体、集成电路 | |
| 新能源 | 新能源、锂电、光伏、储能 | |
| AI | 人工智能、AI、算力、大模型 | |
| 医药 | 医药、生物、医疗、疫苗 | |
| 汽车 | 汽车、车、整车 | |
| 地产 | 地产、房地产、建筑 | |
| 军工 | 军工、国防、航空、航天 | |
| 消费 | 消费、白酒、食品、零售 | |
| 金融 | 银行、保险、证券、金融 | |
| 科技 | 科技、软件、互联网、5G、数码、电子 | ✅ 新增"数码"、"电子" |
| 农业 | 农业、种植、养殖、智农、农牧 | ✅ 新增题材 |
| 有色金属 | 有色、金属、铜、铝、锌、岭南 | ✅ 新增题材 |
| 环保 | 环保、生态、环卫、天楹、垃圾、水务 | ✅ 新增题材 |
| 化工 | 化工、化学、农药、化肥 | ✅ 新增题材 |
| 钢铁 | 钢铁、钢、铁 | ✅ 新增题材 |
| 煤炭 | 煤炭、煤、能源 | ✅ 新增题材 |
| 电力 | 电力、发电、水电、核电 | ✅ 新增题材 |
| 交通 | 交通、物流、航运、港口、快递 | ✅ 新增题材 |
| 传媒 | 传媒、广告、影视、游戏、出版 | ✅ 新增题材 |

---

## ⚙️ 配置参数

**题材有效性阈值** (`config_short_swing.py:48-53`):
```python
THEME_DETECTION = {
    "min_stocks_per_theme": 2,       # 最少股票数: 2只
    "min_avg_change_percent": 2.5,   # 平均涨幅: 2.5%
}
```

**龙头股识别标准**:
- 涨停优先（涨幅≥9.8%）+50分
- 量比≥2.0 +20分
- 涨幅加成（涨幅×2）
- 最低评分要求: 50分

---

## 🚀 API接口

### 获取主线题材列表

**接口**: `GET /api/v1/themes`

**响应示例**:
```json
{
  "success": true,
  "themes": [
    {
      "theme_name": "环保",
      "stocks": [
        {
          "code": "sz000010",
          "name": "美丽生态",
          "change_percent": 5.16,
          "volume_ratio": 4.56,
          "is_leader": false
        },
        {
          "code": "sz000035",
          "name": "中国天楹",
          "change_percent": 10.05,
          "volume_ratio": 1.31,
          "is_leader": true
        }
      ],
      "leader_stock": {
        "code": "sz000035",
        "name": "中国天楹",
        "change_percent": 10.05,
        "is_leader": true
      },
      "avg_change_percent": 7.61,
      "stock_count": 2,
      "score": 55.6
    }
  ],
  "top_theme": {
    "theme_name": "环保",
    "score": 55.6,
    ...
  },
  "message": "检测到 1 个主线题材"
}
```

---

## 🧪 测试验证

### 调试脚本

```bash
# 详细调试信息
python3 quant_system/short_swing/debug_theme_empty.py
```

**输出示例**:
```
【Step 4】基于关键词聚类...
聚类后题材数量: 4

  题材: 环保
  股票数量: 2
  平均涨幅: 7.61%
  股票列表:
    - 美丽生态 (sz000010): +5.16%
    - 中国天楹 (sz000035): +10.05%

【Step 5】题材有效性筛选...
  环保: ✅ 有效
    股票数: 2 (要求>=2)
    平均涨幅: 7.61% (要求>=2.5%)

最终有效题材数量: 1
```

### API测试

```bash
curl http://localhost:8001/api/v1/themes | python3 -m json.tool
```

---

## ❓ 常见问题

### Q1: 为什么返回空数组？

**可能原因**:
1. **非交易时间 + 市场冷清**（最常见）
   - 周末/盘后市场静态快照
   - 强势股票（涨幅≥5%）太少
   - 解决方案: 在交易时间内使用

2. **关键词未覆盖**
   - 股票名称不包含预定义关键词
   - 解决方案: 扩展关键词库

3. **题材强度不够**
   - 股票数量不足2只
   - 平均涨幅未达2.5%
   - 解决方案: 降低阈值

### Q2: 如何添加新的题材类别？

**修改文件**: `quant_system/short_swing/engines/theme_detector.py`

**添加位置**: 第93-113行

```python
theme_keywords = {
    # ... 现有题材 ...
    "新题材名称": ["关键词1", "关键词2", "关键词3"],  # ✅ 在这里添加
}
```

### Q3: 如何调整灵敏度？

**更宽松**（检测更多题材）:
```python
# config_short_swing.py
THEME_DETECTION = {
    "min_stocks_per_theme": 1,       # 降低到1只
    "min_avg_change_percent": 2.0,   # 降低到2%
}
```

**更严格**（只检测强势题材）:
```python
THEME_DETECTION = {
    "min_stocks_per_theme": 3,       # 提高到3只
    "min_avg_change_percent": 4.0,   # 提高到4%
}
```

### Q4: 题材评分如何计算？

**评分公式** (总分100分):
- 股票数量: min(30, 股票数×2)
- 平均涨幅: min(40, 平均涨幅×3)
- 龙头加成: 有龙头股+20分
- 量比加成: min(10, 平均量比×3)

**示例**:
```
环保题材:
  - 股票数量: 2只 → 4分
  - 平均涨幅: 7.61% → 22.83分
  - 龙头加成: 有（中国天楹）→ +20分
  - 量比加成: (4.56+1.31)/2 = 2.94 → 8.82分

总分: 4 + 22.83 + 20 + 8.82 = 55.65分
```

---

## 📊 市场涨幅分布参考

**正常交易日**:
- 涨停（≥9.8%）: 30-100只
- 强势（≥5%）: 100-300只
- 活跃（≥3%）: 300-800只

**市场冷清**（当前周末静态快照）:
- 涨停（≥9.8%）: 1只（1%）
- 强势（≥5%）: 4只（4%）
- 活跃（≥3%）: 6只（6%）

**结论**: 非交易时间强势股票基数小，题材检测更困难。

---

## 🎓 使用建议

### 最佳使用时间

- ✅ **交易时间内**（9:30-11:30, 13:00-15:00）
  - 实时数据，题材检测最准确
  - 可捕捉盘中热点轮动

- ⚠️ **非交易时间**（周末/盘后）
  - 使用上一交易日缓存数据
  - 题材检测可能返回空数组（市场冷清）
  - 仅供参考，不适合实时决策

### 配合使用

**组合查询**:
```bash
# 1. 查看市场情绪
curl http://localhost:8001/api/v1/sentiment

# 2. 查看主线题材
curl http://localhost:8001/api/v1/themes

# 3. 获取选股候选（按题材筛选）
curl -X POST http://localhost:8001/api/v1/candidates \
  -H "Content-Type: application/json" \
  -d '{"limit": 20, "min_score": 75}'
```

---

## 🔗 相关文档

- **详细Bug分析**: `BUGFIX_THEME_EMPTY.md`
- **调试脚本**: `debug_theme_empty.py`
- **配置文件**: `config_short_swing.py`
- **检测引擎**: `engines/theme_detector.py`

---

**最后更新**: 2026-03-01
**版本**: v1.0.1（已修复关键词覆盖问题）
