# 故障排除指南

## 问题：输入内容到错误的位置（如顶部搜索框）

### 症状
- 运行 `test.py` 时，股票代码、价格、数量等信息输入到了同花顺顶部的搜索框
- 并未输入到交易面板的正确输入框中

### 根本原因
这个问题有三个可能的原因：

1. **坐标未校准** - 代码中的坐标是示例值，不匹配你的实际屏幕布局
2. **使用绝对坐标但窗口位置不匹配** - 窗口位置与校准时不同
3. **焦点问题** - 点击后焦点没有正确切换到输入框

### 解决方案

#### 方案1：使用新的校准工具（推荐）

```bash
# 运行校准辅助工具
python3 calibrate_helper.py
```

该工具会：
1. 自动检测同花顺窗口位置
2. 引导你逐个标记每个按钮和输入框的位置
3. 自动生成相对坐标配置代码（推荐）和绝对坐标配置代码
4. 提供可视化反馈

完成校准后，将生成的代码复制到 `ths_mac_trader.py` 的 `__init__` 方法中。

#### 方案2：启用相对坐标模式（已实现）

**新版本已自动启用相对坐标模式**，这意味着：
- 坐标会自动根据窗口位置调整
- 即使移动窗口也能正常工作
- 更加稳定可靠

检查 `ths_mac_trader.py` 中是否有：
```python
self.use_relative_coords = True  # 应该设置为 True
```

#### 方案3：调试当前坐标

如果问题仍然存在，使用调试模式查看实际点击位置：

```python
from ths_mac_trader import THSMacTrader

trader = THSMacTrader()

# 测试当前配置
trader.activate_ths_window()  # 会显示窗口位置

# 会输出实际点击的坐标
trader.buy("603993", price=24.33, quantity=100, confirm=False)
```

查看输出中的 `→ 点击位置: (x, y)` 信息，确认是否点击了正确的位置。

### 具体操作步骤

#### 第一步：确认同花顺窗口已打开

1. 打开同花顺应用
2. 登录到你的券商账户
3. 确保交易面板可见
4. 将窗口放置在一个固定位置（推荐：左上角或居中）

#### 第二步：运行校准工具

```bash
python3 calibrate_helper.py
# 选择选项 1: 开始校准
```

按照提示：
1. 将鼠标移动到"买入"按钮
2. 在终端按 Enter
3. 重复此过程完成所有6个位置的校准

#### 第三步：更新配置

将校准工具生成的代码复制到 `ths_mac_trader.py`:

```python
def __init__(self):
    # ... 其他代码 ...

    # 使用校准工具生成的相对坐标
    self.coords_relative = {
        'buy_button': (271, 90),      # 替换为你的坐标
        'sell_button': (329, 90),     # 替换为你的坐标
        'code_input': (280, 140),     # 替换为你的坐标
        'price_input': (280, 175),    # 替换为你的坐标
        'quantity_input': (280, 212), # 替换为你的坐标
        'confirm_button': (305, 258), # 替换为你的坐标
    }

    self.coords = self.coords_relative.copy()
    self.use_relative_coords = True  # 确保启用相对坐标
```

#### 第四步：测试

```bash
python3 test.py
```

观察输出，确认：
1. 显示了窗口位置信息
2. 显示了实际点击坐标
3. 输入内容到了正确的位置

### 常见问题 Q&A

**Q: 校准后仍然点击错位怎么办？**

A: 检查以下几点：
1. 确保同花顺窗口在前台且没有被其他窗口遮挡
2. 确认输入法是英文模式（数字输入不需要中文输入法）
3. 尝试增加延迟时间：在 `ths_mac_trader.py` 中调整 `pyautogui.PAUSE = 0.5`（从0.3增加到0.5）

**Q: 窗口位置无法获取？**

A: 可能的原因：
1. 同花顺应用名称不匹配 - 检查应用是否叫"同花顺"
2. macOS 权限问题 - 确认已授予辅助功能权限
3. 使用绝对坐标模式作为备选：
   ```python
   self.use_relative_coords = False
   ```

**Q: 点击后没有输入内容？**

A: 可能是焦点问题：
1. 确认点击位置正确（鼠标应该移动到输入框中心）
2. 检查是否有防火墙或安全软件拦截了键盘模拟
3. 尝试使用剪贴板模式（已在新版本中调整）

**Q: 如何验证坐标是否正确？**

A: 使用校准工具的测试功能：
```bash
python3 calibrate_helper.py
# 选择选项 2: 测试坐标
# 输入坐标，程序会移动鼠标并点击该位置
```

### 技术细节

#### 坐标系统说明

**绝对坐标模式**（旧方法）:
- 坐标是相对于整个屏幕的
- 如果移动窗口，坐标就会失效
- 适用于窗口位置完全固定的情况

**相对坐标模式**（新方法，推荐）:
- 坐标是相对于同花顺窗口左上角的
- 会自动检测窗口位置并转换为绝对坐标
- 即使移动窗口也能正常工作
- 更加稳定可靠

#### 点击流程

新版本的点击流程：
```
1. activate_ths_window() - 激活窗口并获取位置
2. get_absolute_coords() - 将相对坐标转换为绝对坐标
3. click_at() - 点击绝对坐标位置
4. 焦点切换延迟（200ms）
5. 清空输入框
6. 输入内容
```

### 日志和调试

启用详细日志输出：

```python
import pyautogui
pyautogui.PAUSE = 0.5  # 增加延迟，便于观察

from ths_mac_trader import THSMacTrader

trader = THSMacTrader()
trader.use_relative_coords = True  # 启用相对坐标

# 观察详细输出
trader.buy("603993", price=24.33, quantity=100, confirm=False)
```

输出会包含：
- `→ 窗口位置: (x, y), 大小: (w x h)` - 窗口信息
- `→ 点击位置: (x, y)` - 实际点击的屏幕坐标

### 预防措施

1. **固定窗口位置** - 虽然相对坐标模式可以适应移动，但建议保持窗口在固定位置
2. **保持窗口可见** - 确保交易面板完全显示，不被其他窗口遮挡
3. **定期重新校准** - 如果更改了屏幕分辨率或窗口布局，需要重新校准
4. **先用模拟盘测试** - 在实盘前务必使用模拟盘确认所有操作正确

### 联系支持

如果以上方法都无法解决问题：

1. 运行 `python3 calibrate_helper.py`，选择"3. 实时鼠标位置"
2. 记录各个按钮和输入框的实际坐标
3. 检查窗口大小和位置是否正常
4. 查看是否有特殊的屏幕缩放设置
