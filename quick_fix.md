# 快速修复指南

## 问题分析

从你的输出可以看到：
```
窗口位置: (56, 25), 大小: (1992x1127)
点击位置: (327, 115)   # = 56 + 271 (相对坐标)
点击位置: (336, 165)   # = 56 + 280
点击位置: (336, 200)   # = 56 + 175
点击位置: (336, 237)   # = 56 + 212
```

**问题确认**：相对坐标系统正常工作，但是相对坐标的数值不对！

当前配置的相对坐标：
- 代码输入框: (280, 140) ← **这个坐标指向了搜索框**
- 价格输入框: (280, 175)
- 数量输入框: (280, 212)

## 立即修复方案

### 方案1：使用增强型校准工具（推荐）

```bash
python3 find_correct_positions.py
```

这个工具会：
1. 引导你逐个标记每个输入框
2. **实时验证** - 立即移动鼠标并点击，确认位置正确
3. 允许重新标记如果位置不对
4. 自动生成配置代码

### 方案2：手动测试定位

#### 步骤1：找到真实坐标

```bash
# 运行实时鼠标追踪
python3 calibrate_helper.py
# 选择选项 3
```

然后：
1. 将鼠标移动到交易面板的**股票代码输入框**中心
2. 记录显示的坐标，例如 (800, 400)
3. 计算相对坐标：
   - 窗口左上角是 (56, 25)
   - 相对坐标 = (800 - 56, 400 - 25) = (744, 375)

#### 步骤2：更新配置

打开 `ths_mac_trader.py`，找到第61-76行左右的 `self.coords_relative`，更新为：

```python
self.coords_relative = {
    'buy_button': (你测量的x - 56, 你测量的y - 25),
    'sell_button': (你测量的x - 56, 你测量的y - 25),
    'code_input': (你测量的x - 56, 你测量的y - 25),  # ← 关键！
    'price_input': (你测量的x - 56, 你测量的y - 25),
    'quantity_input': (你测量的x - 56, 你测量的y - 25),
    'confirm_button': (你测量的x - 56, 你测量的y - 25),
}
```

### 方案3：使用绝对坐标（临时方案）

如果相对坐标总是有问题，可以先用绝对坐标：

#### 步骤1：记录绝对坐标

```bash
python3 calibrate_helper.py
# 选择选项 3 - 实时鼠标位置
```

将鼠标移动到每个输入框，记录坐标。

#### 步骤2：更新配置

在 `ths_mac_trader.py` 的 `__init__` 方法中：

```python
def __init__(self):
    # 使用绝对坐标
    self.coords = {
        'buy_button': (绝对x, 绝对y),
        'sell_button': (绝对x, 绝对y),
        'code_input': (绝对x, 绝对y),      # 记录的实际坐标
        'price_input': (绝对x, 绝对y),
        'quantity_input': (绝对x, 绝对y),
        'confirm_button': (绝对x, 绝对y),
    }

    # 禁用相对坐标模式
    self.use_relative_coords = False  # ← 改为 False
```

⚠️ **注意**：使用绝对坐标后，不能移动窗口！

## 调试技巧

### 查看实际点击位置

运行 test.py 时，注意输出：
```
→ 点击位置: (336, 165)
```

- 如果这个坐标在**屏幕顶部** → 说明坐标太小了
- 如果这个坐标在**交易面板区域** → 说明坐标正确了

### 手动验证坐标

```python
# 在 Python 中测试
import pyautogui
import time

# 移动到某个坐标看看是否正确
pyautogui.moveTo(336, 165)  # 替换为你要测试的坐标
time.sleep(2)  # 看看鼠标在哪里
pyautogui.click()  # 点击测试
```

## 常见坐标参考

基于你的窗口大小 (1992x1127)，这是一个非常宽的窗口。

通常交易面板在窗口的**右侧**或**中间**，所以：

- 如果交易面板在右侧：相对x坐标应该 > 1200
- 如果交易面板在中间：相对x坐标应该在 600-1000 范围

当前你的配置：
- code_input: (280, 140) ← x=280 太小了！这明显在左上角

**猜测正确坐标可能在**：
- 代码输入框: 相对坐标可能是 (1400, 300) 或 (800, 400) 之类
- 绝对坐标可能是 (1456, 325) 或 (856, 425) 之类

## 推荐流程

1. **运行** `python3 find_correct_positions.py`
2. **仔细标记**每个输入框（注意不是搜索框！）
3. **验证**每次点击是否在正确位置
4. **复制**生成的配置代码
5. **测试** `python3 test.py`

记住：交易面板的输入框 ≠ 顶部搜索框！
